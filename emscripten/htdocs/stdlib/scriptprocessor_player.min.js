/**
* Generic ScriptProcessor based WebAudio player. 
*
* 	Copyright (C) 2015 Juergen Wothke
*
* Terms of Use: This software is licensed under a CC BY-NC-SA 
* (http://creativecommons.org/licenses/by-nc-sa/4.0/).
*/
function surrogateCtor(){}function extend(a,b,c){surrogateCtor.prototype=a.prototype,b.prototype=new surrogateCtor,b.prototype.constructor=b,b.base=a;for(var d in c)b.prototype[d]=c[d];return b}var fetchSamples=function(a){var b=window.player.genSamples.bind(window.player);b(a)},calcTick=function(a){var b=window.player.tick.bind(window.player);b(a)},setGlobalWebAudioCtx=function(){if("undefined"==typeof window._gPlayerAudioCtx)try{"webkitAudioContext"in window?window._gPlayerAudioCtx=new webkitAudioContext:window._gPlayerAudioCtx=new AudioContext}catch(a){alert("Web Audio API is not supported in this browser (get Chrome 18 or Firefox 26)"+a)}};AbstractTicker=function(){},AbstractTicker.prototype={init:function(a,b){},calcTickData:function(a,b){},computeAudioSamplesNotify:function(){}};var SAMPLES_PER_BUFFER=8192;AudioBackendAdapterBase=function(a,b){this._resampleBuffer=new Float32Array,this._channels=a,this._bytesPerSample=b,this._sampleRate=44100,this._inputSampleRate=44100,this._observer,this._manualSetupComplete=!0},AudioBackendAdapterBase.prototype={computeAudioSamples:function(){this.error("computeAudioSamples")},loadMusicData:function(a,b,c,d,e){this.error("loadMusicData")},evalTrackOptions:function(a){this.error("evalTrackOptions")},updateSongInfo:function(a,b){this.error("updateSongInfo")},getSongInfoMeta:function(){this.error("getSongInfoMeta")},getAudioBuffer:function(){this.error("getAudioBuffer")},getAudioBufferLength:function(){this.error("getAudioBufferLength")},readFloatSample:function(a,b){this.error("readFloatSample")},getBytesPerSample:function(){return this._bytesPerSample},getChannels:function(){return this._channels},uploadFile:function(a,b){return 0},isManualSetupComplete:function(){return this._manualSetupComplete},teardown:function(){this.error("teardown")},getMaxPlaybackPosition:function(){return 0},getPlaybackPosition:function(){return 0},seekPlaybackPosition:function(a){return-1},getPathAndFilename:function(a){this.error("getPathAndFilename")},registerFileData:function(a,b){this.error("registerFileData")},mapBackendFilename:function(a){return a},handleBackendSongAttributes:function(a,b){this.error("handleBackendSongAttributes")},setObserver:function(a){this._observer=a},error:function(a){alert("fatal error: abstract method '"+a+"' must be defined")},resetSampleRate:function(a,b){a>0&&(this._sampleRate=a),b>0&&(this._inputSampleRate=b);var c=Math.round(SAMPLES_PER_BUFFER*this._sampleRate/this._inputSampleRate)*this.getChannels();c>this._resampleBuffer.length&&(this._resampleBuffer=this.allocResampleBuffer(c))},allocResampleBuffer:function(a){return new Float32Array(a)},getCopiedAudio:function(a,b){var c;for(c=0;c<b*this._channels;c++)this._resampleBuffer[c]=this.readFloatSample(a,c);return b},getResampledAudio:function(a,b){var c;if(this._sampleRate==this._inputSampleRate)c=this.getCopiedAudio(a,b);else{c=Math.round(b*this._sampleRate/this._inputSampleRate);var d=c*this._channels;d>this._resampleBuffer.length&&(this._resampleBuffer=this.allocResampleBuffer(d)),this.resampleChannel(0,a,b,c),2==this._channels&&this.resampleChannel(1,a,b,c)}return c},resampleChannel:function(a,b,c,d){for(var n,o,e=0,f=0,g=d-0,h=c-0,i=Math.abs(g-e),j=e<g?1:-1,k=-Math.abs(h-f),l=f<h?1:-1,m=i+k;o=e*this._channels+a,this._resampleBuffer[o]=this.readFloatSample(b,f*this._channels+a),!(e>=g&&f>=h);)n=2*m,n>k&&(m+=k,e+=j),n<i&&(m+=i,f+=l)},getResampleBuffer:function(){return this._resampleBuffer}},EmsHEAP16BackendAdapter=function(){var a=function(b,c){a.base.call(this,c,2),this.Module=b,window.Math.fround||(window.Math.fround=window.Math.round)};return extend(AudioBackendAdapterBase,a,{registerEmscriptenFileData:function(a,b){try{this.Module.FS_createPath("/",a[0],!0,!0)}catch(a){}var c;try{c=this.Module.FS_createDataFile(a[0],a[1],b,!0,!0);ScriptNodePlayer.getInstance().trace("registerEmscriptenFileData: ["+a[0]+"]["+a[1]+"] size: "+b.length)}catch(a){}return c},readFloatSample:function(a,b){return this.Module.HEAP16[a+b]/32768},getCopiedAudio:function(a,b){var c=0;for(c=0;c<b*this._channels;c++)this._resampleBuffer[c]=this.Module.HEAP16[a+c]/32768;return b}}),a}(),EmsHEAP16BackendAdapter_ASM=function(){var a=function(b,c){a.base.call(this,b,c),this.em_resampleBufferOffset=0};return extend(EmsHEAP16BackendAdapter,a,{allocResampleBuffer:function(a){var b=this.Module._malloc(a*this._channels*this._bytesPerSample);return this.em_resampleBufferOffset&&this.Module._free(this.em_resampleBufferOffset),this.em_resampleBufferOffset=b,new Float32Array(this.Module.HEAPU8.buffer,b,a)},ASM_copy:function(a,b,c){"use asm";var d=new a.Int16Array(c);var e=new a.Float32Array(c);var f=a.Math.fround;function g(a,b,c,g){a=a|0;b=b|0;c=c|0;g=g|0;var h=0;var i=0;a=a<<1;c=c<<1;for(;(h|0)<(c|0);h=(h|0)+2|0,i=(i|0)+4|0){e[(b+i|0)>>2]=f(~d[(a+h|0)>>1])/f(32768)}return c>>1>>g}return{copyAudio:g}},getCopiedAudio:function(a,b){var c=this.Module.HEAP16.buffer;return this.asm_module||(this.asm_module=this.ASM_copy(window,{},c)),this.asm_module.copyAudio(a,this.em_resampleBufferOffset,b*this._channels,2==this._channels?1:0)}}),a}(),FileCache=function(){this._binaryFileMap={},this._pendingFileMap={},this._isWaitingForFile=!1},FileCache.prototype={getFileMap:function(){return this._binaryFileMap},getPendingMap:function(){return this._pendingFileMap},setWaitingForFile:function(a){this._isWaitingForFile=a},isWaitingForFile:function(){return this._isWaitingForFile},getFile:function(a){var b;return a in this._binaryFileMap&&(b=this._binaryFileMap[a]),b},setFile:function(a,b){this._binaryFileMap[a]=b,this._isWaitingForFile=!1}};var ScriptNodePlayer=function(){return PlayerImpl=function(a,b,c,d,e,f,g,h,i){"undefined"==typeof a&&alert("fatal error: backendAdapter not specified"),"undefined"==typeof e&&alert("fatal error: onPlayerReady not specified"),"undefined"==typeof f&&alert("fatal error: onTrackReadyToPlay not specified"),"undefined"==typeof g&&alert("fatal error: onTrackEnd not specified"),a.getChannels()>2&&alert("fatal error: only 1 or 2 output channels supported"),this._backendAdapter=a,this._backendAdapter.setObserver(this),this._basePath=b,this._traceSwitch=!1,this._spectrumEnabled=d,this._songInfo={},this._onTrackReadyToPlay=f,this._onTrackEnd=g,this._onPlayerReady=e,this._onUpdate=h,this._tickerStepWidth=256,"undefined"!=typeof i&&i.init(SAMPLES_PER_BUFFER,this._tickerStepWidth),this._externalTicker=i,this._currentTick=0,this._sourceBuffer,this._sourceBufferLen,this._numberOfSamplesRendered=0,this._numberOfSamplesToRender=0,this._sourceBufferIdx=0,this._currentPlaytime=0,this._currentTimeout=-1,setGlobalWebAudioCtx(),this._sampleRate=window._gPlayerAudioCtx.sampleRate,this._correctSampleRate=this._sampleRate,this._backendAdapter.resetSampleRate(this._sampleRate,-1),this._bufferSource,this._gainNode,this._analyzerNode,this._scriptNode,this._freqByteData=0,window.fileRequestCallback=this.fileRequestCallback.bind(this),window.fileSizeRequestCallback=this.fileSizeRequestCallback.bind(this),window.songUpdateCallback=this.songUpdateCallback.bind(this),this._isPaused=!1,this._isPlayerReady=!1,this._isSongReady=!1,this._initInProgress=!1,this._preLoadReady=!1,window.player=this;var j=window.player.preloadFiles.bind(window.player);j(c,function(){this._preLoadReady=!0,this._preLoadReady&&this._backendAdapter.isManualSetupComplete()&&(this._isPlayerReady=!0,this._onPlayerReady())}.bind(this))},PlayerImpl.prototype={isReady:function(){return this._isPlayerReady},setTraceMode:function(a){this._traceSwitch=a},play:function(){this.initWebAudio(),this._isPaused=!1,"undefined"==typeof this._bufferSource&&(this._bufferSource=window._gPlayerAudioCtx.createBufferSource(),this._bufferSource.start||(this._bufferSource.start=this._bufferSource.noteOn,this._bufferSource.stop=this._bufferSource.noteOff),this._bufferSource.start(0))},pause:function(){this.isWaitingForFile()||this._initInProgress||!this._isSongReady||(this._isPaused=!0)},resume:function(){this.isWaitingForFile()||this._initInProgress||!this._isSongReady||(this._isPaused=!1)},getCurrentTick:function(){var a=Math.ceil(SAMPLES_PER_BUFFER/this._tickerStepWidth)-1;return a=Math.min(a,this._currentTick)},setVolume:function(a){this._gainNode.gain.value=a},isStereo:function(){return 2==this._backendAdapter.getChannels()},getSongInfo:function(){return this._songInfo},getSongInfoMeta:function(){return this._backendAdapter.getSongInfoMeta()},setPlaybackTimeout:function(a){this._currentPlaytime=0,this._currentTimeout=a/1e3*this._sampleRate},getFreqByteData:function(){return this._analyzerNode&&(0===this._freqByteData&&(this._freqByteData=new Uint8Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getByteFrequencyData(this._freqByteData)),this._freqByteData},getMaxPlaybackPosition:function(){return this._backendAdapter.getMaxPlaybackPosition()},getPlaybackPosition:function(){return this._backendAdapter.getPlaybackPosition()},seekPlaybackPosition:function(a){return this._backendAdapter.seekPlaybackPosition(a)},loadMusicFromTmpFile:function(a,b,c,d,e){var f=a.name,g=(b.basePath?b.basePath:this._basePath)+f;if(!this.loadMusicDataFromCache(g,b,d)){var h=new FileReader;h.onload=function(){var a=this._backendAdapter.getPathAndFilename(f),e=new Uint8Array(h.result),i=this._backendAdapter.registerFileData(a,e);return"undefined"==typeof i?void d():(this.getCache().setFile(g,e),this.prepareTrackForPlayback(g,h.result,b),void c(f))}.bind(this),h.onprogress=function(a){e&&e(a.total,a.loaded)}.bind(this),h.readAsArrayBuffer(a)}},loadMusicFromURL:function(a,b,c,d,e){var f=(b.basePath?b.basePath:this._basePath)+a;if(!this.loadMusicDataFromCache(f,b,d)){var g=new XMLHttpRequest;g.open("GET",f,!0),g.responseType="arraybuffer",g.onload=function(a){this.trace("loadMusicFromURL successfully loaded: "+f),this.prepareTrackForPlayback(f,g.response,b)?c(f):this.isWaitingForFile()||d()}.bind(this),g.onprogress=function(a){e&&e(a.total,a.loaded)}.bind(this),g.onreadystatuschange=function(a){4==oReq.readyState&&404==oReq.status&&this.trace("loadMusicFromURL failed to load: "+f)}.bind(this),g.send(null)}},uploadFile:function(a,b,c,d,e){var f=new FileReader;f.onload=function(){var e=this._backendAdapter.getPathAndFilename(a.name),g=new Uint8Array(f.result),h=this._backendAdapter.registerFileData(e,g);if("undefined"==typeof h)return void d();var i=this._backendAdapter.uploadFile(a.name,b);0===i?(c(a.name),this._onPlayerReady()):1==i&&c(a.name)}.bind(this),f.onprogress=function(a){e&&e(a.total,a.loaded)}.bind(this),f.readAsArrayBuffer(a)},prepareTrackForPlayback:function(a,b,c){return this._isPaused=!0,this.lastUsedFilename=a,this.lastUsedData=b,this.lastUsedOptions=c,this._isSongReady=!1,this.setWaitingForFile(!1),this.initIfNeeded(a,b,c)},trace:function(a){this._traceSwitch&&console.log(a)},setWait:function(a){this.setWaitingForFile(a)},getDefaultSampleRate:function(){return this._correctSampleRate},initIfNeeded:function(a,b,c){var d=this.loadMusicData(a,b,c);if(d<0)this._isSongReady=!1,this.setWaitingForFile(!0),this._initInProgress=!1;else{if(0===d){this.setWaitingForFile(!1),this._isSongReady=!0,this._currentPlaytime=0,this._initInProgress=!1,this.trace("successfully completed init");var e=this._backendAdapter.evalTrackOptions(c);return 0!==e?(this.trace("error preparing track options"),!1):(this.updateSongInfo(a),this._onTrackReadyToPlay(),this._isPaused=!1,!0)}this._initInProgress=!1,this.trace("initIfNeeded - fatal error")}return!1},loadMusicDataFromCache:function(a,b,c){var d=this.getCache().getFile(a);return"undefined"!=typeof d&&(this.prepareTrackForPlayback(a,d,b)||this.isWaitingForFile()||c(),!0)},handleBackendEvent:function(){this._backendAdapter.isManualSetupComplete()&&this._preLoadReady&&(this._isPlayerReady=!0,this._onPlayerReady())},initWebAudio:function(){if("undefined"!=typeof this._bufferSource)this._bufferSource.stop(0);else{if(this._analyzerNode=window._gPlayerAudioCtx.createAnalyser(),this._scriptNode=this.createScriptProcessor(window._gPlayerAudioCtx),this._gainNode=window._gPlayerAudioCtx.createGain(),this._scriptNode.connect(this._gainNode),"undefined"!=typeof this._externalTicker){var a=this.createTickerScriptProcessor(window._gPlayerAudioCtx);a.connect(this._gainNode)}this._spectrumEnabled?(this._gainNode.connect(this._analyzerNode),this._analyzerNode.connect(window._gPlayerAudioCtx.destination)):this._gainNode.connect(window._gPlayerAudioCtx.destination)}},updateSongInfo:function(a){this._songInfo={},this._backendAdapter.updateSongInfo(a,this._songInfo)},loadMusicData:function(a,b,c){if(this._backendAdapter.teardown(),b){var d=this._backendAdapter.getPathAndFilename(a),e=new Uint8Array(b);this._backendAdapter.registerFileData(d,e);var f=this._backendAdapter.loadMusicData(this._sampleRate,d[0],d[1],e,c);return 0===f&&this.resetBuffer(),f}},resetBuffer:function(){this._numberOfSamplesRendered=0,this._numberOfSamplesToRender=0,this._sourceBufferIdx=0},resetSampleRate:function(a){this._backendAdapter.resetSampleRate(a,-1),this.resetBuffer()},createScriptProcessor:function(a){var b=a.createScriptProcessor(SAMPLES_PER_BUFFER,0,this._backendAdapter.getChannels());return b.onaudioprocess=fetchSamples,b},createTickerScriptProcessor:function(a){var b;return b=a.createScriptProcessor(256,0,1),b.onaudioprocess=calcTick,b},fillEmpty:function(a,b,c){var d=a-this._numberOfSamplesRendered;for(i=0;i<d;i++)b[i+this._numberOfSamplesRendered]=0,this.isStereo()&&(c[i+this._numberOfSamplesRendered]=0);this._numberOfSamplesToRender=0,this._numberOfSamplesRendered=a},fileRequestCallback:function(a){var b=this._backendAdapter.mapBackendFilename(a);return this.preloadFile(b,function(){this.initIfNeeded(this.lastUsedFilename,this.lastUsedData,this.lastUsedOptions)}.bind(this),!1)},fileSizeRequestCallback:function(a){var b=this._backendAdapter.mapBackendFilename(a),c=this.getCache().getFile(b);return c.length},songUpdateCallback:function(a){this._backendAdapter.handleBackendSongAttributes(a,this._songInfo),this._onUpdate&&this._onUpdate()},preload:function(a,b,c){if(0===b)c();else{b--;var d=function(){this.preload(a,b,c)}.bind(this);this.preloadFile(a[b],d,!0)}},preloadFile:function(a,b,c){var d=this.getCache().getFile(a);if("undefined"!=typeof d){var e=0;return 0==d&&(e=1,this.trace("error: preloadFile could not get cached: "+a)),c&&b(),e}if(this._isPaused=!0,this.setWaitingForFile(!0),this._isSongReady=!1,!(a in this.getCache().getPendingMap())){this.getCache().getPendingMap()[a]=1;var f=new XMLHttpRequest;f.open("GET",a,!0),f.responseType="arraybuffer",f.onload=function(c){var d=f.response;if(d){this.trace("preloadFile successfully loaded: "+a);var e=this._backendAdapter.getPathAndFilename(a),g=new Uint8Array(d);this._backendAdapter.registerFileData(e,g);this.getCache().setFile(a,g)}delete this.getCache().getPendingMap()[a]||this.trace("remove file from pending failed: "+a),b()}.bind(this),f.onreadystatuschange=function(b){4==f.readyState&&404==f.status&&(this.trace("preloadFile failed to load: "+a),this.getCache().setFile(a,0))}.bind(this),f.onerror=function(b){this.getCache().setFile(a,0)}.bind(this),f.send(null)}return-1},tick:function(a){this._currentTick++},genSamples:function(a){var c,b=a.outputBuffer.getChannelData(0);if(this.isStereo()&&(c=a.outputBuffer.getChannelData(1)),!this._isSongReady||this.isWaitingForFile()||this._isPaused){var d;for(d=0;d<b.length;d++)b[d]=0,this.isStereo()&&(c[d]=0)}else{var e=b.length;for(this._numberOfSamplesRendered=0;this._numberOfSamplesRendered<e;){if(0===this._numberOfSamplesToRender){var f;if(this._currentTimeout>0&&this._currentPlaytime>this._currentTimeout?(this.trace("'song end' forced after "+this._currentTimeout/this._sampleRate+" secs"),f=1):(f=this._backendAdapter.computeAudioSamples(),"undefined"!=typeof this._externalTicker&&this._externalTicker.computeAudioSamplesNotify()),0!==f)return this.fillEmpty(e,b,c),f<0?(this._isPaused=!0,this._isSongReady=!1,void this.setWaitingForFile(!0)):this.isWaitingForFile()?void 0:(f>1&&this.trace("playback aborted with an error"),void(this._onTrackEnd?this._onTrackEnd():this._isPaused=!0));this._sourceBuffer=this._backendAdapter.getAudioBuffer(),this._sourceBufferLen=this._backendAdapter.getAudioBufferLength(),this._numberOfSamplesToRender=this._backendAdapter.getResampledAudio(this._sourceBuffer,this._sourceBufferLen),this._sourceBufferIdx=0}var g=this._backendAdapter.getResampleBuffer();this.isStereo()?this.copySamplesStereo(g,b,c,e):this.copySamplesMono(g,b,c,e)}this._currentPlaytime+=e}"undefined"!=typeof this._externalTicker&&(this._externalTicker.calcTickData(b,c),this._currentTick=0)},copySamplesStereo:function(a,b,c,d){var e;if(this._numberOfSamplesRendered+this._numberOfSamplesToRender>d){var f=d-this._numberOfSamplesRendered;for(e=0;e<f;e++)b[e+this._numberOfSamplesRendered]=a[this._sourceBufferIdx++],c[e+this._numberOfSamplesRendered]=a[this._sourceBufferIdx++];this._numberOfSamplesToRender-=f,this._numberOfSamplesRendered=d}else{for(e=0;e<this._numberOfSamplesToRender;e++)b[e+this._numberOfSamplesRendered]=a[this._sourceBufferIdx++],c[e+this._numberOfSamplesRendered]=a[this._sourceBufferIdx++];this._numberOfSamplesRendered+=this._numberOfSamplesToRender,this._numberOfSamplesToRender=0}},copySamplesMono:function(a,b,c,d){var e;if(this._numberOfSamplesRendered+this._numberOfSamplesToRender>d){var f=d-this._numberOfSamplesRendered;for(e=0;e<f;e++)b[e+this._numberOfSamplesRendered]=a[this._sourceBufferIdx++];this._numberOfSamplesToRender-=f,this._numberOfSamplesRendered=d}else{for(e=0;e<this._numberOfSamplesToRender;e++)b[e+this._numberOfSamplesRendered]=a[this._sourceBufferIdx++];this._numberOfSamplesRendered+=this._numberOfSamplesToRender,this._numberOfSamplesToRender=0}},preloadFiles:function(a,b){this._isPaused=!0,this.preload(a,a.length,b)},setWaitingForFile:function(a){this.getCache().setWaitingForFile(a)},isWaitingForFile:function(){return this.getCache().isWaitingForFile()},getCache:function(){return"undefined"==typeof window._fileCache&&(window._fileCache=new FileCache),window._fileCache}},{createInstance:function(a,b,c,d,e,f,g,h,i){var j=!1;if("undefined"!=typeof window.player){var k=window.player;k._isPaused=!0,"undefined"!=typeof k._bufferSource&&k._bufferSource.stop(0),k._scriptNode&&k._scriptNode.disconnect(0),k._analyzerNode&&k._analyzerNode.disconnect(0),k._gainNode&&k._gainNode.disconnect(0),j=k._traceSwitch}var l=new PlayerImpl(a,b,c,d,e,f,g,h,i);l._traceSwitch=j},getInstance:function(){return"undefined"==typeof window.player&&alert("fatal error: window.player not defined"),window.player}}}();